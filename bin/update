#!/bin/bash

set -e

trap 'err $LINENO' SIGTERM

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
LIME_YELLOW=$(tput setaf 190)
YELLOW=$(tput setaf 3)
POWDER_BLUE=$(tput setaf 153)
BLUE=$(tput setaf 4)
END=$(tput sgr0)

echo_ok() { echo -e "${BLUE}$1""${END}"; }
echo_warn() { echo -e "${YELLOW}$1""${END}"; }
err() {
    echo "${RED}ERROR: $1"
    echo_error "ERROR: $1"
    awk 'NR>L-4 && NR<L+4 { printf "%-5d%3s%s\n", NR, (NR==L?">>>":""),$0 }' L="$1" "$0"
    echo "${END}"
}

on_start() {
    echo
    echo "${BLUE}Updating System"
    echo "${LIME_YELLOW}                   __      __           "
    echo "${GREEN}  __  ______  ____/ /___ _/ /____  _____      "
    echo "${RED} / / / / __ \/ __  / __ \`/ __/ _ \/ ___/       "
    echo "${POWDER_BLUE}/ /_/ / /_/ / /_/ / /_/ / /_/  __(__  ) " 
    echo "${BLUE}\__,_/ .___/\__,_/\__,_/\__/\___/____/         "
    echo "${BLUE}    /_/${END}                                  " 
    echo
}

exists() {
    command -v "$1" > /dev/null 2>&1
}

update_homebrew() {
    if ! exists; then
        return
    fi
    brew update
    brew upgrade
    brew cu -ay
    brew cleanup
}

update_packages() {
    echo "Updating packages"
    tldr --update
    echo
}

update_apps() {
    if ! exists gem; then
        return
    fi
    echo_ok "Updating Apps"
    mas upgrade
    echo
}

update_gems() {
    if ! exists gem; then
        return
    fi
    echo "Updating ruby gems"
    sudo gem update
    echo
}

update_omz() {
    "$ZSH"/tools/upgrade.sh
    echo
}

update_vim_plugins() {
    echo_ok "Updating Vim-Plug"
    nvim +PlugUpdate +qall
    echo
}


on_finish() {
    echo
    echo "${LIME_YELLOW}                   __      __           "
    echo "${GREEN}  __  ______  ____/ /___ _/ /____  _____      "
    echo "${RED} / / / / __ \/ __  / __ \`/ __/ _ \/ ___/       "
    echo "${POWDER_BLUE}/ /_/ / /_/ / /_/ / /_/ / /_/  __(__  ) " 
    echo "${BLUE}\__,_/ .___/\__,_/\__,_/\__/\___/____/         "
    echo "${BLUE}    /_/                                        " 
    echo "${END}"
    echo_ok "Hooray! Everything is up-to-date!"
    echo
}

main() {
    on_start
    echo "Password:"
    sudo -v
    echo
    update_homebrew
    update_packages
    update_apps
    update_gems
    update_vim_plugins
    update_omz
    # Keep as last
    softwareupdate -i -a
    on_finish
}

main "$@"
